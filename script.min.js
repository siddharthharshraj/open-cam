let video=document.querySelector("video"),recordBtnCont=document.querySelector(".record-btn-cont"),recordBtn=document.querySelector(".record-btn"),captureBtnCont=document.querySelector(".capture-btn-cont"),captureBtn=document.querySelector(".capture-btn"),recordFlag=!1,transparentColor="transparent",currentStream=null,screenStream=null,currentMode="camera",availableDevices={cameras:[],microphones:[]},recorder,chunks=[],constraints={video:{width:{ideal:1280},height:{ideal:720},facingMode:"user"},audio:!0};async function initializeCamera(){try{const e=await navigator.mediaDevices.getUserMedia(constraints);currentStream=e,video.srcObject=e,video.addEventListener("loadedmetadata",()=>{document.body.classList.add("camera-ready")}),recorder=new MediaRecorder(e),recorder.addEventListener("start",e=>{chunks=[],recordBtn.classList.add("recording")}),recorder.addEventListener("dataavailable",e=>{chunks.push(e.data)}),recorder.addEventListener("stop",e=>{recordBtn.classList.remove("recording");let t=new Blob(chunks,{type:"video/mp4"});if(db){let e={id:shortid(),blob:t,url:URL.createObjectURL(t),type:"video",timestamp:Date.now()};videoStore.add(e),showSuccess("Video saved to gallery!")}else console.warn("Database not available, video not saved")}),await enumerateDevices()}catch(e){console.error("Error accessing camera:",e),showError("Camera access denied or not available")}}async function enumerateDevices(){try{const e=await navigator.mediaDevices.enumerateDevices();availableDevices.cameras=e.filter(e=>"videoinput"===e.kind),availableDevices.microphones=e.filter(e=>"audioinput"===e.kind),populateDeviceSelectors()}catch(e){console.error("Error enumerating devices:",e),showError("Unable to access media devices")}}function populateDeviceSelectors(){const e=document.getElementById("cameraSelect"),t=document.getElementById("micSelect");e.innerHTML="",t.innerHTML="",availableDevices.cameras.forEach(t=>{const a=document.createElement("option");a.value=t.deviceId,a.textContent=t.label||`Camera ${e.children.length+1}`,e.appendChild(a)}),availableDevices.microphones.forEach(e=>{const a=document.createElement("option");a.value=e.deviceId,a.textContent=e.label||`Microphone ${t.children.length+1}`,t.appendChild(a)});const a=document.querySelectorAll(".mode-btn");a.forEach(e=>{e.addEventListener("click",()=>{a.forEach(e=>e.classList.remove("active")),e.classList.add("active"),currentMode=e.dataset.mode,showSuccess(`Switched to ${e.textContent} mode`)})})}async function reinitializeCamera(){try{currentStream&&currentStream.getTracks().forEach(e=>e.stop()),await initializeCamera(),showSuccess("Camera settings updated")}catch(e){console.error("Error reinitializing camera:",e),showError("Failed to update camera settings")}}recordBtnCont.addEventListener("click",async e=>{recordFlag?(recorder.stop(),recordFlag=!1,recordBtn.classList.remove("scale-record"),stopTimer(),showSuccess("Video recorded successfully!")):(recordFlag=!0,recordBtn.classList.add("scale-record"),startTimer(),await startRecording())});async function startRecording(){try{let e;switch(currentMode){case"camera":e=currentStream;break;case"screen":screenStream=await navigator.mediaDevices.getDisplayMedia({video:{mediaSource:"screen"},audio:!0}),e=screenStream;break;case"both":screenStream=await navigator.mediaDevices.getDisplayMedia({video:{mediaSource:"screen"},audio:!0}),e=screenStream,showSuccess("Recording screen (camera overlay not implemented in this demo)");break;default:e=currentStream}recorder=new MediaRecorder(e),recorder.addEventListener("dataavailable",e=>{chunks.push(e.data)}),recorder.addEventListener("stop",()=>{let e=new Blob(chunks,{type:"video/mp4"});if(db){let t={id:shortid(),blob:e,url:URL.createObjectURL(e),type:"video",timestamp:Date.now()};videoStore.add(t),showSuccess("Video saved to gallery!")}else console.warn("Database not available, video not saved")}),recorder.start()}catch(e){console.error("Error starting recording:",e),showError("Failed to start recording. Screen sharing may not be supported."),recordFlag=!1}}captureBtnCont.addEventListener("click",e=>{captureBtn.classList.add("scale-capture");let t=document.createElement("canvas");t.width=video.videoWidth,t.height=video.videoHeight;let a=t.getContext("2d");a.drawImage(video,0,0),""!==transparentColor&&"transparent"!==transparentColor&&(a.fillStyle=transparentColor,a.fillRect(0,0,t.width,t.height)),t.toBlob(e=>{if(db){let t={id:shortid(),blob:e,url:URL.createObjectURL(e),type:"image",timestamp:Date.now()};imageStore.add(t),showSuccess("Photo captured successfully!")}else console.warn("Database not available, photo not saved")},transparentColor&&"transparent"!==transparentColor?"image/png":"image/jpeg"),setTimeout(()=>{captureBtn.classList.remove("scale-capture")},500)});let timerInterval;function startTimer(){const e=document.querySelector(".timer");e.style.display="block";let t=0;timerInterval=setInterval(()=>{t++;const a=Math.floor(t/60),r=t%60;e.textContent=`${a.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`},1e3)}function stopTimer(){clearInterval(timerInterval),document.querySelector(".timer").style.display="none"}let footerToggle=document.querySelector(".footer-toggle"),footer=document.querySelector(".footer"),actionCont=document.querySelector(".action-cont");footerToggle.addEventListener("click",e=>{footer.classList.toggle("show"),actionCont.classList.toggle("footer-active");const t=footerToggle.querySelector("i");footer.classList.contains("show")?t.style.transform="rotate(180deg)":t.style.transform="rotate(0deg)"});document.addEventListener("DOMContentLoaded",function(){let e=document.querySelector(".filter-layer"),t=document.querySelectorAll(".filter");console.log("Filter elements found:",t.length),console.log("Filter layer found:",e),t.forEach(a=>{a.addEventListener("click",r=>{console.log("Filter clicked:",a.className),t.forEach(e=>e.classList.remove("active")),a.classList.add("active");let s="transparent";a.classList.contains("orange")?s="rgba(255, 165, 0, 0.4)":a.classList.contains("brown")?s="rgba(165, 42, 42, 0.4)":a.classList.contains("pink")?s="rgba(255, 192, 203, 0.4)":a.classList.contains("transparent")&&(s="transparent"),console.log("Applying filter color:",s),transparentColor=s,e&&(e.style.backgroundColor=s,e.style.transition="background-color 0.3s ease");const o=a.title||"Filter";showSuccess(`${o} applied`)})})});document.addEventListener("keydown",e=>{"INPUT"!==e.target.tagName&&"SELECT"!==e.target.tagName&&("Space"===e.code?(e.preventDefault(),captureBtnCont.click()):"KeyR"===e.code?(e.preventDefault(),recordBtnCont.click()):"KeyS"===e.code?(e.preventDefault(),document.getElementById("settingsBtn").click()):"Escape"===e.code&&(e.preventDefault(),document.getElementById("controlsPanel").classList.remove("active")))});function showSuccess(e){const t=document.createElement("div");t.className="success-message",t.textContent=e,t.style.cssText="position: fixed;top: 2rem;right: 2rem;background: #10b981;color: white;padding: 0.75rem 1.5rem;border-radius: 10px;z-index: 1000;font-weight: 500;transform: translateX(100%);transition: transform 0.3s ease;",document.body.appendChild(t),setTimeout(()=>{t.style.transform="translateX(0)"},100),setTimeout(()=>{t.style.transform="translateX(100%)",setTimeout(()=>t.remove(),300)},2e3)}function showError(e){const t=document.createElement("div");t.className="error-message",t.textContent=e,t.style.cssText="position: fixed;top: 2rem;right: 2rem;background: #ef4444;color: white;padding: 0.75rem 1.5rem;border-radius: 10px;z-index: 1000;font-weight: 500;transform: translateX(100%);transition: transform 0.3s ease;",document.body.appendChild(t),setTimeout(()=>{t.style.transform="translateX(0)"},100),setTimeout(()=>{t.style.transform="translateX(100%)",setTimeout(()=>t.remove(),300)},2e3)}function handleScreenShareEnded(){recordFlag&&"camera"!==currentMode&&(recordBtnCont.click(),showError("Screen sharing ended. Recording stopped."))}navigator.mediaDevices.addEventListener("devicechange",async()=>{console.log("Media devices changed"),await enumerateDevices()}),initializeCamera();Toggle=document.querySelector('.footer-toggle');const footer=document.querySelector('.footer');const actionCont=document.querySelector('.action-cont');footerToggle.addEventListener('click',()=>{footer.classList.toggle('show');actionCont.classList.toggle('footer-active');const icon=footerToggle.querySelector('i');if(footer.classList.contains('show')){icon.style.transform='rotate(180deg)'}else{icon.style.transform='rotate(0deg)'}})
